{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit Task{% else %}Create Task{% endif %}{% endblock %}
{% block content %} 
  <link rel="stylesheet" href="{% static 'css/flatpickr.min.css' %}?v=2">

  <h2>{% if form.instance.pk %}Edit Task{% else %}Create Task{% endif %}</h2>
  <form method="post">
    {% csrf_token %}
    <div class="card mb-4">
      <div class="card-body">
        {% if form.errors %}
          <div class="alert alert-danger">
            <strong>Please correct the errors below.</strong>
          </div>
        {% endif %}

        {% for field in form %}
          {% if field.name == 'parent' %}
            <!-- Defer rendering of parent field -->
          {% elif field.name == 'due_date' %}
          <a href="{% url 'tasks:category_create' %}" class="btn btn-outline-success btn-sm">
                    <i class="fas fa-plus"></i> Add Category
                </a>
            <div class="mb-3">
              <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
              <div class="date-with-icon">
                {{ field }}
                <button type="button" id="dueDateIcon" class="calendar-toggle" aria-label="Open calendar">ðŸ“…</button>
              </div>
              {% if field.help_text %}
                <div class="form-text">{{ field.help_text }}</div>
              {% endif %}
              {% for error in field.errors %}
                <div class="text-danger">{{ error }}</div>
              {% endfor %}
            </div>
          {% else %}
            <div class="mb-3">
              <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
              {{ field }}
              {% if field.help_text %}
                <div class="form-text">{{ field.help_text }}</div>
              {% endif %}
              {% for error in field.errors %}
                <div class="text-danger">{{ error }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endfor %}

        <button type="submit" class="btn btn-primary">{% if form.instance.pk %}Update{% else %}Create Task{% endif %}</button>
  </form>
  <button class="btn btn-secondary" onclick="window.history.back()">Cancel</button>
      </div>
    </div>
    

  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const fp = flatpickr('input[name="due_date"]', {
      dateFormat: 'Y-m-d',
      allowInput: true
    });
    document.getElementById('dueDateIcon')?.addEventListener('click', () => fp.open());
  </script>
{% endblock %}