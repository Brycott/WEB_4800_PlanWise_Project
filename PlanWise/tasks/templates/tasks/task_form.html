{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit Task{% else %}Create Task{% endif %}{% endblock %}
{% block content %} 
  <link rel="stylesheet" href="{% static 'css/flatpickr.min.css' %}?v=2">

  <h2>{% if form.instance.pk %}Edit Task{% else %}Create Task{% endif %}</h2>
  <form method="post">
    {% csrf_token %}
    <div class="card mb-4">
      <div class="card-body">
        {% if form.errors %}
          <div class="alert alert-danger">
            <strong>Please correct the errors below.</strong>
          </div>
        {% endif %}

        {% for field in form %}
          {% if field.name == 'parent' %}
            <!-- Defer rendering of parent field -->
          {% elif field.name == 'due_date' %}
          <a href="{% url 'tasks:category_create' %}" class="btn btn-outline-success btn-sm">
                    <i class="fas fa-plus"></i> Add Category
                </a>
            <div class="mb-3">
              <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
              <div class="date-with-icon">
                {{ field }}
              </div>
              {% if field.help_text %}
                <div class="form-text">{{ field.help_text }}</div>
              {% endif %}
              {% for error in field.errors %}
                <div class="text-danger">{{ error }}</div>
              {% endfor %}
            </div>
          {% elif field.name == 'is_recurring' %}
            <div class="mb-3 form-check">
              {{ field }} 
              <label for="{{ field.id_for_label }}" class="form-check-label">{{ field.label }}</label>
            </div>
          {% elif field.name == 'recurrence_frequency' or field.name == 'recurrence_end_date' %}
            <div class="mb-3 recurrence-fields" style="display: none;">
              <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
              {{ field }}
            </div>
          {% else %}
            <div class="mb-3">
              <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
              {{ field }}
              {% if field.help_text %}
                <div class="form-text">{{ field.help_text }}</div>
              {% endif %}
              {% for error in field.errors %}
                <div class="text-danger">{{ error }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endfor %}

        

        <button type="submit" class="btn btn-primary">{% if form.instance.pk %}Update{% else %}Create Task{% endif %}</button>
  </form>
  <button class="btn btn-secondary" onclick="window.history.back()">Cancel</button>
  {% if form.instance.pk and not form.instance.parent %}
        <input type="hidden" name="parent" value="{{ form.instance.pk }}">
        {% endif %}
      </div>
    </div>
    {% if form.instance.pk and not form.instance.parent %}
    <div class="d-flex w-100 gap-2 mb-3">
      <a href="{% url 'tasks:task_detail' form.instance.pk %}" class="btn btn-info h-25">Add Subtask</a>
      </div>
    </div>
    {% endif %}
  </form>

  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const fp = flatpickr('input[name="due_date"]', {
      dateFormat: 'Y-m-d',
      allowInput: true
    });
    document.getElementById('dueDateIcon')?.addEventListener('click', () => fp.open());

    const isRecurringCheckbox = document.getElementById('id_is_recurring');
    const recurrenceFields = document.querySelectorAll('.recurrence-fields');

    isRecurringCheckbox.addEventListener('change', function() {
      recurrenceFields.forEach(field => {
        field.style.display = this.checked ? 'block' : 'none';
      });
    });

    // Trigger the change event on page load to set the initial state
    isRecurringCheckbox.dispatchEvent(new Event('change'));
  </script>
{% endblock %}